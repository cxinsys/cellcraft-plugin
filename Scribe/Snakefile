import os

rule TENET_Input:
    input:
        input="user/{user_name}/data/{input.h5ad}"
    output:
        expression="user/{user_name}/workflow_{workflow_id}/algorithm_{algorithm_id}/results/expression.csv",
        trajectory="user/{user_name}/workflow_{workflow_id}/algorithm_{algorithm_id}/results/trajectory.txt",
        cellSelect="user/{user_name}/workflow_{workflow_id}/algorithm_{algorithm_id}/results/cellSelect.txt"
    params:
        geneList=lambda wildcards: "user/{user_name}/data/{geneList.txt}" if os.path.exists("user/{user_name}/data/{geneList.txt}") else "None",
        UMAP_lasso=lambda wildcards: {UMAP lasso} if os.path.exists({UMAP lasso}) else "None",
        cell_group={cell group},
        pseudotime={pseudotime},
        clusters=lambda wc: ";".join({clusters})
    log:
        stdout="user/{user_name}/workflow_{workflow_id}/algorithm_{algorithm_id}/logs/TENET_Input.stdout",
        stderr="user/{user_name}/workflow_{workflow_id}/algorithm_{algorithm_id}/logs/TENET_Input.stderr"
    shell:
        "/opt/micromamba/envs/plugin_env/bin/python /scripts/tenet_input.py {input.input} {params.geneList} {params.UMAP_lasso} {output.expression} {output.trajectory} {output.cellSelect} {params.cell_group} {params.pseudotime} '{params.clusters}' > {log.stdout} 2> {log.stderr}"

rule Run:
    input:
        expression="user/{user_name}/workflow_{workflow_id}/algorithm_{algorithm_id}/results/expression.csv",
        trajectory="user/{user_name}/workflow_{workflow_id}/algorithm_{algorithm_id}/results/trajectory.txt",
        cellSelect="user/{user_name}/workflow_{workflow_id}/algorithm_{algorithm_id}/results/cellSelect.txt"
    output:
        rankedEdges="user/{user_name}/workflow_{workflow_id}/algorithm_{algorithm_id}/results/rankedEdges.txt",
        GRN="user/{user_name}/workflow_{workflow_id}/algorithm_{algorithm_id}/results/GRN.sif",
        GRNOutdegree="user/{user_name}/workflow_{workflow_id}/algorithm_{algorithm_id}/results/GRNOutdegree.txt"
    params:
        Lower_Limit={Lower Limit},
        Expression_Family={Expression Family},
        method={method},
        Delay={Delay},
        log={log},
        number_of_outdegrees={number of outdegrees},
        FDR={FDR}
    log:
        stdout="user/{user_name}/workflow_{workflow_id}/algorithm_{algorithm_id}/logs/Run.stdout",
        stderr="user/{user_name}/workflow_{workflow_id}/algorithm_{algorithm_id}/logs/Run.stderr"
    shell:
        """
        cd /workspace
        
        echo "=== COMPREHENSIVE DEBUGGING ===" > {log.stdout}
        echo "Date: $(date)" >> {log.stdout}
        echo "Working Directory: $(pwd)" >> {log.stdout}
        echo "User: $(whoami)" >> {log.stdout}
        echo "UID: $(id -u), GID: $(id -g)" >> {log.stdout}
        
        # R 환경 기본 설정
        export R_HOME=/opt/micromamba/envs/plugin_env/lib/R
        export RENV_CONFIG_AUTOLOADER_ENABLED=FALSE
        
        echo "=== ENVIRONMENT VARIABLES ===" >> {log.stdout}
        echo "R_HOME: $R_HOME" >> {log.stdout}
        echo "PATH: $PATH" >> {log.stdout}
        env | grep -E "(R_|RENV_)" >> {log.stdout}
        
        echo "=== R VERSION AND BASIC INFO ===" >> {log.stdout}
        /opt/micromamba/envs/plugin_env/bin/Rscript --version >> {log.stdout} 2>&1
        
        echo "=== DEFAULT R LIBRARY PATHS ===" >> {log.stdout}
        /opt/micromamba/envs/plugin_env/bin/Rscript -e "cat('Default .libPaths():\\n'); print(.libPaths()); cat('\\n')" >> {log.stdout} 2>&1
        
        echo "=== SEARCHING FOR MONOCLE PACKAGE ===" >> {log.stdout}
        echo "Searching in /workspace/dependency..." >> {log.stdout}
        if [ -d "/workspace/dependency" ]; then
            find /workspace/dependency -name "*monocle*" -type d 2>/dev/null >> {log.stdout} || echo "No monocle directories found in /workspace/dependency" >> {log.stdout}
            find /workspace/dependency -name "monocle" -type d 2>/dev/null >> {log.stdout} || true
        else
            echo "/workspace/dependency directory does NOT exist" >> {log.stdout}
        fi
        
        echo "Searching in entire /workspace..." >> {log.stdout}
        find /workspace -name "*monocle*" -type d 2>/dev/null | head -10 >> {log.stdout} || echo "No monocle directories found in /workspace" >> {log.stdout}
        
        echo "=== RENV DIRECTORY STRUCTURE ===" >> {log.stdout}
        if [ -d "/workspace/dependency/renv" ]; then
            echo "renv directory exists" >> {log.stdout}
            find /workspace/dependency/renv -type d -maxdepth 4 >> {log.stdout}
            
            echo "Contents of renv/library:" >> {log.stdout}
            if [ -d "/workspace/dependency/renv/library" ]; then
                find /workspace/dependency/renv/library -name "*" -maxdepth 4 | head -20 >> {log.stdout} || echo "Error reading renv/library contents" >> {log.stdout}
            else
                echo "/workspace/dependency/renv/library does NOT exist" >> {log.stdout}
            fi
        else
            echo "renv directory NOT FOUND" >> {log.stdout}
        fi
        
        echo "=== TESTING DIFFERENT LIBRARY PATHS ===" >> {log.stdout}
        
        # 테스트할 경로들 배열 선언
        echo "Testing path: /workspace/dependency/renv/library/linux-debian-bullseye/R-4.4/x86_64-conda-linux-gnu" >> {log.stdout}
        if [ -d "/workspace/dependency/renv/library/linux-debian-bullseye/R-4.4/x86_64-conda-linux-gnu" ]; then
            echo "  Directory exists" >> {log.stdout}
            echo "  Contents (first 10):" >> {log.stdout}
            ls -la "/workspace/dependency/renv/library/linux-debian-bullseye/R-4.4/x86_64-conda-linux-gnu" 2>/dev/null | head -10 >> {log.stdout}
            if [ -d "/workspace/dependency/renv/library/linux-debian-bullseye/R-4.4/x86_64-conda-linux-gnu/monocle" ]; then
                echo "  ✓ monocle package FOUND!" >> {log.stdout}
            else
                echo "  ✗ monocle package NOT found" >> {log.stdout}
            fi
        else
            echo "  Directory does NOT exist" >> {log.stdout}
        fi
        
        echo "Testing path: /workspace/dependency/renv/library/R-4.4/x86_64-conda-linux-gnu" >> {log.stdout}
        if [ -d "/workspace/dependency/renv/library/R-4.4/x86_64-conda-linux-gnu" ]; then
            echo "  Directory exists" >> {log.stdout}
            echo "  Contents (first 10):" >> {log.stdout}
            ls -la "/workspace/dependency/renv/library/R-4.4/x86_64-conda-linux-gnu" 2>/dev/null | head -10 >> {log.stdout}
            if [ -d "/workspace/dependency/renv/library/R-4.4/x86_64-conda-linux-gnu/monocle" ]; then
                echo "  ✓ monocle package FOUND!" >> {log.stdout}
            else
                echo "  ✗ monocle package NOT found" >> {log.stdout}
            fi
        else
            echo "  Directory does NOT exist" >> {log.stdout}
        fi
        
        echo "Testing path: /opt/micromamba/envs/plugin_env/lib/R/library" >> {log.stdout}
        if [ -d "/opt/micromamba/envs/plugin_env/lib/R/library" ]; then
            echo "  Directory exists" >> {log.stdout}
            echo "  Contents (first 10):" >> {log.stdout}
            ls -la "/opt/micromamba/envs/plugin_env/lib/R/library" 2>/dev/null | head -10 >> {log.stdout}
            if [ -d "/opt/micromamba/envs/plugin_env/lib/R/library/monocle" ]; then
                echo "  ✓ monocle package FOUND!" >> {log.stdout}
            else
                echo "  ✗ monocle package NOT found" >> {log.stdout}
            fi
        else
            echo "  Directory does NOT exist" >> {log.stdout}
        fi
        
        echo "=== TESTING R WITH FORCED LIBRARY PATHS ===" >> {log.stdout}
        
        if [ -d "/workspace/dependency/renv/library/linux-debian-bullseye/R-4.4/x86_64-conda-linux-gnu" ]; then
            echo "Testing R with renv path..." >> {log.stdout}
            /opt/micromamba/envs/plugin_env/bin/Rscript -e "
            .libPaths(c('/workspace/dependency/renv/library/linux-debian-bullseye/R-4.4/x86_64-conda-linux-gnu', .libPaths()))
            cat('Library paths after setting:\\n')
            print(.libPaths())
            cat('\\nTrying to load monocle:\\n')
            tryCatch({{
                library(monocle, warn.conflicts = FALSE, quietly = FALSE)
                cat('✓ SUCCESS: monocle loaded!\\n')
                cat('monocle version:', as.character(packageVersion('monocle')), '\\n')
            }}, error = function(e) {{
                cat('✗ FAILED:', e\\$message, '\\n')
            }})
            cat('\\n')
            " >> {log.stdout} 2>&1
        fi
        
        if [ -d "/opt/micromamba/envs/plugin_env/lib/R/library" ]; then
            echo "Testing R with conda path..." >> {log.stdout}
            /opt/micromamba/envs/plugin_env/bin/Rscript -e "
            .libPaths(c('/opt/micromamba/envs/plugin_env/lib/R/library', .libPaths()))
            cat('Library paths after setting:\\n')
            print(.libPaths())
            cat('\\nTrying to load monocle:\\n')
            tryCatch({{
                library(monocle, warn.conflicts = FALSE, quietly = FALSE)
                cat('✓ SUCCESS: monocle loaded!\\n')
                cat('monocle version:', as.character(packageVersion('monocle')), '\\n')
            }}, error = function(e) {{
                cat('✗ FAILED:', e\\$message, '\\n')
            }})
            cat('\\n')
            " >> {log.stdout} 2>&1
        fi
        
        echo "=== CHECKING ACTUAL R PACKAGE INSTALLATION ===" >> {log.stdout}
        echo "Finding where monocle is actually installed..." >> {log.stdout}
        /opt/micromamba/envs/plugin_env/bin/Rscript -e "
        # Get all library paths
        all_paths <- .libPaths()
        cat('All library paths:\\n')
        print(all_paths)
        cat('\\n')
        
        # Find monocle in all possible locations
        for(path in all_paths) {{
            if(dir.exists(path)) {{
                pkgs <- list.dirs(path, full.names = FALSE, recursive = FALSE)
                if('monocle' %in% pkgs) {{
                    cat('✓ FOUND monocle in:', path, '\\n')
                }}
            }}
        }}
        
        # Try to load monocle without any path manipulation
        cat('\\nTrying to load monocle with default paths...\\n')
        tryCatch({{
            library(monocle)
            cat('✓ SUCCESS: monocle loaded with default paths!\\n')
            cat('monocle is installed at:', system.file(package='monocle'), '\\n')
        }}, error = function(e) {{
            cat('✗ FAILED with default paths\\n')
            
            # Try installing monocle if not found
            cat('\\nSearching for monocle in all R library paths...\\n')
            monocle_found <- FALSE
            for(path in all_paths) {{
                monocle_path <- file.path(path, 'monocle')
                if(dir.exists(monocle_path)) {{
                    cat('Found monocle at:', monocle_path, '\\n')
                    monocle_found <- TRUE
                }}
            }}
            
            if(!monocle_found) {{
                cat('\\nMONOCLE NOT FOUND IN ANY R LIBRARY PATH!\\n')
                cat('This container may not have monocle installed.\\n')
            }}
        }})
        " >> {log.stdout} 2>&1
        
        echo "=== FINAL ATTEMPT ===" >> {log.stdout}
        echo "Running Scribe script..." >> {log.stdout}
        /opt/micromamba/envs/plugin_env/bin/Rscript /scripts/scribe_for_cellcraft.R {input.expression} {input.trajectory} {input.cellSelect} {params.Lower_Limit} {params.Expression_Family} {params.method} {params.Delay} {params.log} {params.number_of_outdegrees} {params.FDR} {output.rankedEdges} {output.GRN} {output.GRNOutdegree} >> {log.stdout} 2>> {log.stderr}
        """
